<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <script src="./web/ball.js"></script>
        <script src="./web/table.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/msgpack-lite/0.1.26/msgpack.min.js" integrity="sha512-harMiusNxs02ryf3eqc3iQalz2RSd0z38vzOyuFwvQyW046h2m+/47WiDmPW9soh/p71WQMRSkhSynEww3/bOA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <style>
            * {
                padding: 0;
                margin: 0;
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <canvas id="gameplay" style="height: 100vh;width: 100vw;" height="1080" width="1920"></canvas>
        <span id="ping"></span>
    </body>
    <script>
        const gameDisplay = document.getElementById('gameplay');
        const game = gameDisplay.getContext('2d');

        var delay = 0;

        function getRandom(min,max){
            return Math.floor(Math.random()*(max-min+1))+min;
        };

        function ping() {
            delay = 0;
            ws.send(msgpack.encode({
                name: "ping",
                timeStamp: Date.now()
            }));
        }

        function drawMiddleLine() {
            game.beginPath();
            game.moveTo(gameDisplay.width/2, 0);
            game.lineTo(gameDisplay.width/2, gameDisplay.height);
            game.stroke();
        }

        function createObject(dt) {
            window.player1ID = dt.data[0];
            window.player2ID = dt.data[1];

            if (window.userID == window.player1ID) {
                window.player = 0;
            } else {
                window.player = 1;
            }

            window.player1 = new Table(150, "#4287f5", 12, 150, 390, 1080, 1920);
            window.player2 = new Table(150, "#89c206", 12, 1770, 390, 1080, 1920);
            window.ball = new Ball(15, "#000", 5, 960, 540, 1080, 1920);
        }

        function render(dt) {
            game.clearRect(0, 0, gameDisplay.width, gameDisplay.height);

            if (window.player == 0) {
                game.font = "3em Arial";
                game.fillStyle = "#000";
                game.fillText("Your Aera", 400, 1000);
            } else {
                game.font = "3em Arial";
                game.fillStyle = "#000";
                game.fillText("Your Aera", 1360, 1000);
            }

            drawMiddleLine();

            window.player1.move(dt.data[player1ID].x, dt.data[player1ID].y);
            window.player2.move(dt.data[player2ID].x, dt.data[player2ID].y);
            window.ball.move(dt.data["ball"].x, dt.data["ball"].y);
        }

        const ws = new WebSocket(`ws://${location.host}`);

        ws.onmessage = async (msg) => {
            var dt = msgpack.decode(new Uint8Array(await msg.data.arrayBuffer()));
            switch (dt.name) {
                case "userID":
                    window.userID = dt.value;
                    break;

                case "gameStart":
                    createObject(dt);
                    break;

                case "gameStatus":
                    window.gameStart = true;
                    render(dt);
                    break;

                case "status":
                    if (dt.value === 0) console.log("Game starts in 3 seconds");
                    break;
                
                case "pong":
                    document.getElementById('ping').innerHTML = `Ping: ${delay}ms`;
                    // setTimeout(ping(), 200);
                    break;
            }
        }

        setInterval(() => {
            delay++;
        }, 1);

        window.addEventListener("load", () => {

            ping();

            ws.send(msgpack.encode({name:"start"}));

            document.onkeydown = (e) => {
                if (!window.gameStart) return;
                switch (e.key) {
                    case "ArrowUp":
                        ws.send(msgpack.encode({
                            name: "keydown",
                            value: 0
                        }));
                        break;
                    case "ArrowDown":
                        ws.send(msgpack.encode({
                            name: "keydown",
                            value: 1
                        }));
                        break;
                }
            }

            document.onkeyup = () => {
                ws.send(msgpack.encode({
                    name: "keyup"
                }));
            }

        });
    </script>
</html>